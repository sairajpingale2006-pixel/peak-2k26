<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peak 2K26</title>

<style>
:root{
  --bg:#0b0b0b;
  --panel:#111;
  --border:#1f1f1f;
  --accent:#b30000;
  --accent-dark:#700000;
  --text:#e6e6e6;
  --muted:#777;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border)}
h1{margin:0;font-size:16px;letter-spacing:1px}
#coins{color:var(--accent);font-size:14px}

.tabs{display:flex;border-bottom:1px solid var(--border)}
.tab{padding:12px 16px;cursor:pointer;font-size:13px;color:var(--muted)}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.container{padding:20px;max-width:1100px;margin:auto}
.section{display:none}
.section.active{display:block}

.panel{background:var(--panel);border:1px solid var(--border);padding:16px;margin-bottom:16px}
.meta{font-size:12px;color:var(--muted)}
.row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.row.missed{opacity:.5}

.check{width:22px;height:22px;border:2px solid var(--muted);cursor:pointer}
.check.done{background:var(--accent);border-color:var(--accent)}

.btn{padding:8px 14px;background:var(--accent-dark);border:none;color:#fff;cursor:pointer;font-size:13px}
.btn.secondary{background:#333}

input,select{
  width:100%;
  padding:8px;
  background:#000;
  color:#fff;
  border:1px solid #333;
  margin-bottom:8px
}

.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.cell{
  height:26px;
  background:#222;
}
.cell.fail{background:#b30000}
.cell.ok{background:#2b6f8c}

.ai{
  font-size:14px;
  line-height:1.4;
}
.ai strong{color:var(--accent)}
</style>
</head>

<body>

<header>
  <h1>PEAK 2K26</h1>
  <div id="coins">Coins: 0</div>
</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('habits')">Habits</div>
  <div class="tab" onclick="showTab('mega')">Mega</div>
  <div class="tab" onclick="showTab('economy')">Economy</div>
  <div class="tab" onclick="showTab('analytics')">Analytics</div>
  <div class="tab" onclick="showTab('settings')">Settings</div>
</div>

<div class="container">

<!-- HABITS -->
<div id="habits" class="section active">
  <div class="panel">
    <div id="habitList"></div>
    <button class="btn" onclick="openHabit()">+ Add Habit</button>
  </div>
</div>

<!-- MEGA -->
<div id="mega" class="section">
  <div class="panel">
    <div id="megaList"></div>
    <button class="btn" onclick="openMega()">+ Add Mega</button>
  </div>
</div>

<!-- ECONOMY -->
<div id="economy" class="section">
  <div class="panel">
    <button class="btn" onclick="openSpend()">Spend Coins</button>
  </div>
  <div class="panel">
    <div class="meta">Spend History</div>
    <div id="spendList"></div>
  </div>
</div>

<!-- ANALYTICS -->
<div id="analytics" class="section">
  <div class="panel">
    <div class="meta">Weekly Summary</div>
    <div id="weeklySummary"></div>
  </div>

  <div class="panel">
    <div class="meta">Failure Heatmap (Last 7 Days)</div>
    <div class="grid" id="heatmap"></div>
  </div>

  <div class="panel ai" id="aiPanel"></div>
</div>

<!-- SETTINGS -->
<div id="settings" class="section">
  <div class="panel">
    <div class="meta">Theme</div>
    <select onchange="setTheme(this.value)">
      <option value="demonic">Demonic</option>
      <option value="emerald">Emerald</option>
      <option value="ocean">Ocean</option>
    </select>
  </div>
  <div class="panel">
    <button class="btn secondary" onclick="logout()">Logout</button>
  </div>
</div>

</div>

<!-- MODALS -->
<div class="modal" id="habitModal"><div class="panel">
  <input id="habitName" placeholder="Habit name">
  <input id="habitTime" placeholder="Time window">
  <button class="btn" onclick="addHabit()">Add</button>
</div></div>

<div class="modal" id="megaModal"><div class="panel">
  <input id="megaTitle" placeholder="Mega title">
  <input id="megaReward" type="number" placeholder="Coin reward">
  <button class="btn" onclick="addMega()">Add</button>
</div></div>

<div class="modal" id="spendModal"><div class="panel">
  <input id="spendAmount" type="number" placeholder="Coins to spend">
  <input id="spendReason" placeholder="Reason">
  <button class="btn" onclick="spendCoins()">Confirm</button>
</div></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* === FIREBASE INIT (unchanged) === */
const firebaseConfig = {
  apiKey: "AIzaSyCv1tDAxtNMiI2otPWNmnlIgatzR2VxuyU",
  authDomain: "peak-2k26-web.firebaseapp.com",
  projectId: "peak-2k26-web",
  storageBucket: "peak-2k26-web.appspot.com",
  messagingSenderId: "1006854372406",
  appId: "1:1006854372406:web:3acb7885e6dddc8065ac97"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let userRef,data;
const TODAY=new Date().toDateString();

/* === THEMES === */
const THEMES={
  demonic:{bg:"#0b0b0b",accent:"#b30000",dark:"#700000"},
  emerald:{bg:"#07110b",accent:"#00b36b",dark:"#007a4a"},
  ocean:{bg:"#07131a",accent:"#4fa3c7",dark:"#2b6f8c"}
};
function applyTheme(n){
  const t=THEMES[n];
  document.documentElement.style.setProperty("--bg",t.bg);
  document.documentElement.style.setProperty("--accent",t.accent);
  document.documentElement.style.setProperty("--accent-dark",t.dark);
 인정}
async function setTheme(n){
  applyTheme(n);
  if(userRef){await userRef.update({theme:n});data.theme=n;}
}

/* === AUTH === */
auth.onAuthStateChanged(async u=>{
  if(!u){location.reload();return;}
  userRef=db.collection("users").doc(u.uid);
  const snap=await userRef.get();
  data=snap.data();
  applyTheme(data.theme||"demonic");
  dailyReset();
  renderAll();
});

/* === UI === */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  event.target.classList.add("active");
  document.getElementById(id).classList.add("active");
}

/* === HABITS / MEGA / SPEND (unchanged logic) === */
function openHabit(){habitModal.style.display="flex"}
function openMega(){megaModal.style.display="flex"}
function openSpend(){spendModal.style.display="flex"}

async function addHabit(){
  if(!habitName.value)return;
  data.habits.push({name:habitName.value,time:habitTime.value,streak:0,lastCompleted:null,done:false,missed:false});
  habitName.value=habitTime.value="";
  habitModal.style.display="none";
  await save();renderAll();
}
async function toggleHabit(i){
  const h=data.habits[i];
  if(h.done)return;
  const y=new Date(Date.now()-86400000).toDateString();
  h.streak=(h.lastCompleted===y)?h.streak+1:1;
  h.lastCompleted=TODAY;h.done=true;h.missed=false;
  data.coins++;
  await save();renderAll();
}

async function addMega(){
  if(!megaTitle.value||!megaReward.value)return;
  data.mega.push({title:megaTitle.value,reward:+megaReward.value,done:false});
  megaTitle.value=megaReward.value="";
  megaModal.style.display="none";
  await save();renderAll();
}
async function completeMega(i){
  const m=data.mega[i];
  if(m.done)return;
  m.done=true;data.coins+=m.reward;
  await save();renderAll();
}

async function spendCoins(){
  const a=+spendAmount.value;
  if(a<=0||a>data.coins)return;
  data.coins-=a;
  data.spend.unshift({amount:a,reason:spendReason.value,date:new Date().toLocaleString()});
  spendAmount.value=spendReason.value="";
  spendModal.style.display="none";
  await save();renderAll();
}

/* === ANALYTICS + AI === */
function analytics(){
  const total=data.habits.length;
  const done=data.habits.filter(h=>h.done).length;
  const rate=total?Math.round(done/total*100):0;
  weeklySummary.innerHTML=`Completed <strong>${done}</strong> of ${total} habits (${rate}%)`;

  heatmap.innerHTML="";
  for(let i=0;i<7;i++){
    const fail=i>=done;
    heatmap.innerHTML+=`<div class="cell ${fail?"fail":"ok"}"></div>`;
  }

  let msg="You’re stable.";
  if(done===0) msg="<strong>No habits done.</strong> You chose comfort over discipline.";
  else if(rate<50) msg="You’re inconsistent. Fix execution.";
  else if(rate>80) msg="Momentum detected. Do not slow down.";

  aiPanel.innerHTML=msg;
}

/* === RESET / SAVE / RENDER === */
function dailyReset(){
  if(data.lastDate!==TODAY){
    data.habits.forEach(h=>{if(!h.done)h.missed=true;h.done=false});
    data.lastDate=TODAY;save();
  }
}
async function save(){await userRef.update(data)}

function renderAll(){
  coins.textContent="Coins: "+data.coins;

  habitList.innerHTML="";
  data.habits.forEach((h,i)=>{
    habitList.innerHTML+=`
    <div class="row ${h.missed?"missed":""}">
      <div>${h.name}<div class="meta">${h.time} · Streak ${h.streak}d</div></div>
      <div class="check ${h.done?"done":""}" onclick="toggleHabit(${i})"></div>
    </div>`;
  });

  megaList.innerHTML="";
  data.mega.forEach((m,i)=>{
    megaList.innerHTML+=`
    <div class="row ${m.done?"missed":""}">
      <div>${m.title}<div class="meta">${m.reward} coins</div></div>
      <div class="check ${m.done?"done":""}" onclick="completeMega(${i})"></div>
    </div>`;
  });

  spendList.innerHTML=data.spend.map(
    s=>`−${s.amount} (${s.reason}) <span class="meta">${s.date}</span>`
  ).join("<br>");

  analytics();
}

function logout(){auth.signOut()}
</script>

</body>
</html>
